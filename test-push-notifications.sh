#!/bin/bash

# üß™ Script de Teste do Sistema de Notifica√ß√µes Push
# Este script demonstra como testar o sistema de 3 n√≠veis implementado

echo "üöÄ TESTE DO SISTEMA DE NOTIFICA√á√ïES PUSH - 3 N√çVEIS"
echo "=================================================="

# Configura√ß√µes
API_BASE="http://localhost:8080/api"
CONTENT_TYPE="Content-Type: application/json"

echo ""
echo "üìã PR√â-REQUISITOS:"
echo "1. ‚úÖ Aplica√ß√£o rodando em localhost:8080"
echo "2. ‚úÖ Database com dados de usu√°rios, organiza√ß√µes e contratos"
echo "3. ‚úÖ Pelo menos 1 cliente com contrato titular"
echo "4. ‚úÖ Pelo menos 1 motoboy com tokens push"

echo ""
echo "üîç Verificando se aplica√ß√£o est√° rodando..."
if curl -s "$API_BASE/actuator/health" > /dev/null; then
    echo "‚úÖ Aplica√ß√£o est√° online!"
else
    echo "‚ùå Aplica√ß√£o n√£o est√° rodando. Execute: ./gradlew bootRun"
    exit 1
fi

echo ""
echo "üìù EXEMPLO DE TESTE MANUAL:"
echo ""

echo "1Ô∏è‚É£ CRIAR NOVA DELIVERY (que ativar√° o sistema de notifica√ß√£o):"
echo ""
echo "curl -X POST '$API_BASE/deliveries' \\"
echo "  -H '$CONTENT_TYPE' \\"
echo "  -H 'Authorization: Bearer YOUR_JWT_TOKEN' \\"
echo "  -d '{"
echo "    \"client\": {\"id\": \"CLIENT_UUID_HERE\"},"
echo "    \"fromAddress\": \"Rua das Flores, 123\","
echo "    \"fromLatitude\": -23.550520,"
echo "    \"fromLongitude\": -46.633308,"
echo "    \"toAddress\": \"Avenida Paulista, 456\","
echo "    \"toLatitude\": -23.561414,"
echo "    \"toLongitude\": -46.656219,"
echo "    \"recipientName\": \"Jo√£o Silva\","
echo "    \"recipientPhone\": \"11999999999\","
echo "    \"totalAmount\": 50.00,"
echo "    \"itemDescription\": \"Documento importante\""
echo "  }'"

echo ""
echo "2Ô∏è‚É£ MONITORAR LOGS DA APLICA√á√ÉO:"
echo "Ap√≥s criar a delivery, verifique os logs para ver o processo de notifica√ß√£o:"
echo ""
echo "LOGS ESPERADOS:"
echo "üìÑ Iniciando notifica√ß√£o de motoboys para delivery {id}"
echo "üìÑ Executando N√≠vel 1: Organiza√ß√£o titular para delivery {id}"
echo "üìÑ Notifica√ß√£o N√≠vel 1 enviada para delivery {id}"
echo "üìÑ (ou ap√≥s 2min) Executando N√≠vel 2: Outras organiza√ß√µes..."
echo "üìÑ (ou ap√≥s +2min) Executando N√≠vel 3: Todos motoboys pr√≥ximos..."

echo ""
echo "3Ô∏è‚É£ TESTAR TOKENS PUSH:"
echo ""
echo "# Registrar token de teste para motoboy"
echo "curl -X POST '$API_BASE/push/tokens' \\"
echo "  -H '$CONTENT_TYPE' \\"
echo "  -H 'Authorization: Bearer COURIER_JWT_TOKEN' \\"
echo "  -d '{"
echo "    \"token\": \"ExponentPushToken[FAKE_TOKEN_FOR_TESTING]\","
echo "    \"platform\": \"EXPO\","
echo "    \"deviceType\": \"MOBILE\""
echo "  }'"

echo ""
echo "# Enviar notifica√ß√£o de teste"
echo "curl -X POST '$API_BASE/push/test/{userId}' \\"
echo "  -H 'Authorization: Bearer ADMIN_JWT_TOKEN'"

echo ""
echo "üéØ RESULTADOS ESPERADOS:"
echo "================================"
echo ""
echo "‚úÖ N√çVEL 1 (Organiza√ß√£o Titular):"
echo "   - Busca motoboys da organiza√ß√£o titular do cliente"
echo "   - Filtra apenas dispon√≠veis e pr√≥ximos (5km ‚Üí 10km)"
echo "   - Envia notifica√ß√µes push"
echo "   - Se encontrar: PARA o processo"
echo "   - Se n√£o encontrar: Aguarda 2min ‚Üí N√≠vel 2"
echo ""
echo "‚úÖ N√çVEL 2 (Outras Organiza√ß√µes):"
echo "   - Busca motoboys de outras organiza√ß√µes do cliente"
echo "   - Aplica mesmo filtro geogr√°fico"
echo "   - Se encontrar: PARA o processo"
echo "   - Se n√£o encontrar: Aguarda 2min ‚Üí N√≠vel 3"
echo ""
echo "‚úÖ N√çVEL 3 (Todos Pr√≥ximos):"
echo "   - Busca TODOS motoboys dispon√≠veis na √°rea"
echo "   - Sem restri√ß√£o de organiza√ß√£o"
echo "   - Envia para todos encontrados"
echo "   - FIM do processo"

echo ""
echo "üìä MONITORAMENTO:"
echo "=================="
echo ""
echo "1. Logs da aplica√ß√£o (n√≠vel INFO/DEBUG)"
echo "2. Status das deliveries no banco:"
echo "   SELECT id, status, created_at FROM deliveries ORDER BY created_at DESC LIMIT 5;"
echo ""
echo "3. Tokens push ativos:"
echo "   SELECT u.name, upt.platform, upt.is_active FROM user_push_tokens upt"
echo "   JOIN users u ON u.id = upt.user_id WHERE upt.is_active = true;"

echo ""
echo "üîß CONFIGURA√á√ïES IMPORTANTES:"
echo "=============================="
echo ""
echo "# application.properties"
echo "expo.access-token=\${EXPO_ACCESS_TOKEN:}"
echo "expo.push-url=\${EXPO_PUSH_URL:https://exp.host/--/api/v2/push/send}"
echo ""
echo "# Vari√°veis de ambiente para produ√ß√£o"
echo "export EXPO_ACCESS_TOKEN='your_real_expo_token'"

echo ""
echo "üéâ SISTEMA IMPLEMENTADO COM SUCESSO!"
echo "====================================="
echo ""
echo "O sistema de notifica√ß√µes push com 3 n√≠veis est√° pronto!"
echo "Para testar completamente, execute o comando de cria√ß√£o de delivery acima"
echo "e monitore os logs da aplica√ß√£o para ver o processo em a√ß√£o."

echo ""
echo "üìû Para suporte: Verifique SISTEMA_NOTIFICACAO_PUSH_COMPLETO.md"