# Deploy - 21/11/2025

## âœ… Deploy Realizado com Sucesso

**Commit:** `b38df72`  
**Branch:** `main`  
**RepositÃ³rio:** `github.com:fabio1974/mvt-events.git`

## ğŸ“¦ MudanÃ§as Deployadas

### ğŸ—„ï¸ MigraÃ§Ãµes de Banco de Dados (V60-V66)

1. **V60:** `add_client_location_to_users.sql`
   - Adiciona `client_latitude` e `client_longitude` Ã  tabela `users`

2. **V61:** `remove_emergency_contact_from_users.sql`
   - Remove campo `emergency_contact` obsoleto

3. **V62:** `rename_gps_columns_in_users.sql`
   - Renomeia para `gps_latitude` e `gps_longitude`

4. **V63:** `rename_address_coordinates_to_simple_names.sql`
   - Renomeia `address_latitude/longitude` para `latitude/longitude` em `deliveries`

5. **V64:** `add_organization_to_deliveries.sql`
   - Adiciona campo `organization_id` em `deliveries`
   - CriaÃ§Ã£o de Ã­ndice para melhor performance

6. **V65:** `add_payout_tracking_to_payout_items.sql`
   - Adiciona campos de tracking: `beneficiary_id`, `status`, `paid_at`, `payment_reference`, `payment_method`, `notes`
   - CriaÃ§Ã£o de Ã­ndices para queries otimizadas

7. **V66:** `remove_unified_payout.sql`
   - Remove coluna `payout_id` de `payout_items`
   - Drop da tabela `unified_payouts`

### ğŸ†• Novos Arquivos

- `PayoutItemController.java` - Controller para gerenciar repasses individuais
- `PayoutItemService.java` - Service para lÃ³gica de negÃ³cio de repasses
- `GEOLOCATION_FIELDS.md` - DocumentaÃ§Ã£o dos campos de geolocalizaÃ§Ã£o
- `UNIFIED_PAYOUT_REMOVED.md` - DocumentaÃ§Ã£o da remoÃ§Ã£o do UnifiedPayout

### âŒ Arquivos Removidos

- `UnifiedPayout.java` (Entity)
- `UnifiedPayoutController.java`
- `UnifiedPayoutService.java`
- `UnifiedPayoutRepository.java`
- `UnifiedPayoutSpecification.java`
- `UnifiedPayoutCreateRequest.java` (DTO)
- `UnifiedPayoutResponse.java` (DTO)

### ğŸ”§ Arquivos Modificados (37 files changed)

#### Entities
- `User.java` - Campos de geolocalizaÃ§Ã£o renomeados
- `Delivery.java` - Campo `organization` adicionado, coordenadas renomeadas
- `Payment.java` - Ajustes para integraÃ§Ã£o com PayoutItem
- `PayoutItem.java` - Campos de tracking adicionados, referÃªncia a UnifiedPayout removida

#### Controllers
- `AuthController.java` - JWT inclui coordenadas do usuÃ¡rio
- `DeliveryController.java` - Filtro por `clientId` para CLIENT role
- `UserController.java` - Endpoints de geolocalizaÃ§Ã£o atualizados

#### Services
- `DeliveryService.java` - LÃ³gica de atribuiÃ§Ã£o de organizaÃ§Ã£o
- `UserService.java` - Gerenciamento de coordenadas
- `CustomUserDetailsService.java` - Carregamento de usuÃ¡rio otimizado

#### Repositories
- `DeliveryRepository.java` - Queries com fetch joins para evitar lazy loading
- `PayoutItemRepository.java` - Queries por beneficiÃ¡rio e status
- `ClientContractRepository.java` - Query para buscar contratos ativos
- `EmploymentContractRepository.java` - Query para buscar contratos ativos
- `UserRepository.java` - Queries otimizadas

#### Metadata & Utils
- `JwtUtil.java` - InclusÃ£o de latitude/longitude no token
- `MetadataService.java` - RemoÃ§Ã£o de UnifiedPayout do registro
- `JpaMetadataExtractor.java` - Melhorias na extraÃ§Ã£o de metadados

## ğŸ“Š EstatÃ­sticas do Commit

```
37 files changed
4,686 insertions(+)
5,433 deletions(-)
```

**Saldo:** -747 linhas (cÃ³digo mais enxuto e limpo!)

## ğŸš€ Auto Deploy

O Render irÃ¡ detectar automaticamente o push para `main` e iniciar o deploy:

1. âœ… Build da imagem Docker
2. âœ… ExecuÃ§Ã£o das migraÃ§Ãµes Flyway (V60-V66)
3. âœ… Deploy da aplicaÃ§Ã£o
4. âœ… Health check em `/actuator/health`

## ğŸ” Monitoramento

Acesse o dashboard do Render para monitorar:
- https://dashboard.render.com

### Logs em Tempo Real
```bash
# No dashboard do Render, acesse "Logs" do serviÃ§o mvt-events-api
```

### VerificaÃ§Ã£o de Health
ApÃ³s o deploy, a URL do health check serÃ¡:
```
https://mvt-events-api.onrender.com/actuator/health
```

## âœ¨ Principais Melhorias Deployadas

### 1. GeolocalizaÃ§Ã£o
- âœ… JWT inclui coordenadas do usuÃ¡rio logado
- âœ… Campos renomeados para melhor semÃ¢ntica
- âœ… Delivery agora tem latitude/longitude do endereÃ§o

### 2. OrganizaÃ§Ã£o em Deliveries
- âœ… Campo `organization_id` adicionado
- âœ… AtribuiÃ§Ã£o automÃ¡tica ao aceitar delivery (baseado em contratos)
- âœ… Limpeza automÃ¡tica ao cancelar delivery

### 3. Sistema de Repasses Simplificado
- âœ… Arquitetura simplificada: Payment â†’ PayoutItem â†’ User
- âœ… Tracking individual por beneficiÃ¡rio
- âœ… Status independente por repasse
- âœ… Suporte a mÃºltiplos mÃ©todos de pagamento

### 4. Performance
- âœ… Fetch joins para evitar N+1 queries
- âœ… Ãndices otimizados nas tabelas
- âœ… Queries customizadas para filtros especÃ­ficos

### 5. CorreÃ§Ãµes
- âœ… CLIENT role agora vÃª suas prÃ³prias deliveries
- âœ… Lazy loading issues resolvidos
- âœ… Filtros de delivery funcionando corretamente

## ğŸ“ PrÃ³ximos Passos

ApÃ³s o deploy ser concluÃ­do:

1. Verificar logs no Render
2. Testar endpoint de health: `GET /actuator/health`
3. Testar endpoints de deliveries com CLIENT role
4. Testar endpoints de payout items
5. Validar JWT com coordenadas do usuÃ¡rio

## ğŸ”— Links Ãšteis

- **RepositÃ³rio:** https://github.com/fabio1974/mvt-events
- **Commit:** https://github.com/fabio1974/mvt-events/commit/b38df72
- **Dashboard Render:** https://dashboard.render.com

---

**Deploy iniciado automaticamente via GitHub webhook** ğŸš€
